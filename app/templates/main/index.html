<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRPC 管理控制台</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap-icons.css') }}" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #3730a3;
            --secondary-color: #f8fafc;
            --text-color: #374151;
            --text-light: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --error-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
        }
        /* 主容器样式 */
        .main-container {
            max-width: 1500px; /* 进一步增大最大宽度 */
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 40px); /* 预留页脚高度，避免出现额外滚动 */
            background: var(--bg-color);
        }
        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .user-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            position: relative;
        }
        /* 选项卡样式 */
        .nav-tabs {
            border-bottom: none;
            padding: 0 24px;
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            margin: 0;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 12px 12px 0 0;
            color: var(--text-light);
            font-weight: 500;
            padding: 16px 24px;
            margin-right: 4px;
            transition: all 0.3s ease;
            background: transparent;
        }

        .nav-tabs .nav-link:hover {
            border-color: transparent;
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary-color);
        }

        .nav-tabs .nav-link.active {
            background: white;
            color: var(--primary-color);
            border-color: transparent;
            box-shadow: var(--shadow-sm);
        }

        /* 内容区域 */
        .tab-content {
            padding: 24px;
            min-height: 600px;
            min-width: 1400px; /* 确保内容区域有足够宽度 */
            overflow-x: auto; /* 支持水平滚动 */
        }

        /* 按钮组样式 */
        .action-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
            padding: 20px;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .btn-modern {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary.btn-modern {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-success.btn-modern {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-warning.btn-modern {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn-danger.btn-modern {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }

        .btn-info.btn-modern {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
            color: white;
        }

        /* 表格样式 */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: visible; /* 改为可见，防止截断 */
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            min-width: 1400px; /* 进一步增大最小宽度 */
            width: 100%; /* 充分利用可用宽度 */
            min-height: 700px; /* 设置统一的最小高度 */
        }
        .modern-table {
            width: 100%;
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
        }

        .modern-table thead th {
            background: linear-gradient(135deg, var(--secondary-color), #f1f5f9);
            color: var(--text-color);
            font-weight: 600;
            padding: 10px 16px; /* 进一步减少表头高度 */
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            font-size: 16px; /* 进一步增大表头字体 */
            white-space: nowrap;
        }

        .modern-table tbody td {
            padding: 10px 16px; /* 进一步减少单元格高度 */
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 16px; /* 进一步增大单元格字体 */
            line-height: 1.3; /* 优化行高，更紧凑 */
        }

        /* 专门为IP、端口、域名等数据列设置更大字体 */
        .modern-table tbody td:nth-child(3), /* 本地IP */
        .modern-table tbody td:nth-child(4), /* 本地端口 */
        .modern-table tbody td:nth-child(5), /* 远程端口 */
        .modern-table tbody td:nth-child(6), /* 自定义域名 */
        .modern-table tbody td:nth-child(7)  /* 路由 */ {
            font-size: 16px; /* 增大数据列字体 */
            font-weight: 500; /* 略微加粗，提高可读性 */
        }

        /* code 标签字体优化 */
        .modern-table tbody td code {
            font-size: 16px; /* 确保 code 标签也是 16px */
            font-weight: 600; /* 加粗，更突出 */
            background: rgba(59, 130, 246, 0.08); /* 淡蓝色背景 */
            padding: 2px 6px;
            border-radius: 4px;
            color: #1e40af; /* 深蓝色文字 */
        }

        .modern-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .modern-table tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.02);
        }

        /* 为特定列设置宽度 */
        .modern-table th:nth-child(8), /* 状态列 */
        .modern-table td:nth-child(8) {
            width: 150px; /* 进一步增大状态列宽度，确保“已启用”一行显示 */
            min-width: 150px;
        }
        
        .modern-table th:nth-child(9), /* 操作列 */
        .modern-table td:nth-child(9) {
            width: 200px; /* 进一步增大操作列宽度，确保按钮完整显示 */
            min-width: 200px;
        }

        /* 状态指示器 */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px; /* 增加内边距，给文字更多空间 */
            border-radius: 20px;
            font-size: 13px; /* 略微增大字体 */
            font-weight: 600; /* 加粗文字 */
            text-transform: none; /* 去除大写转换，缩短宽度 */
            letter-spacing: 0.02em; /* 减少字母间距 */
            white-space: nowrap; /* 确保不换行 */
        }

        .status-badge.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-badge.offline {
            background: rgba(107, 114, 128, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(107, 114, 128, 0.2);
        }

        .status-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online {
            background: var(--success-color);
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
            animation: pulse-green 2s infinite;
        }

        .status-dot.offline {
            background: var(--text-light);
        }

        .status-dot.error {
            background: var(--error-color);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        /* 操作按钮组 */
        .table-actions {
            display: flex;
            gap: 6px; /* 略微减少间距，为按钮节省空间 */
            justify-content: flex-end;
            white-space: nowrap; /* 防止换行 */
            width: 100%; /* 使对齐效果可见 */
        }
        /* 服务器配置页面：操作列按钮左对齐 */
        #server .table-actions {
            justify-content: flex-start !important;
        }
        /* 服务器配置页面：增强选择器，确保最后一列的按钮左对齐 */
        #server .modern-table td:last-child .table-actions {
            justify-content: flex-start !important;
        }

        .btn-sm.btn-modern {
            padding: 8px 14px; /* 进一步增加按钮内边距 */
            font-size: 13px; /* 增大按钮字体 */
            border-radius: 8px;
            min-width: 80px; /* 增大最小宽度，确保按钮有更大空间 */
            white-space: nowrap; /* 确保按钮文字不换行 */
        }

        .btn-sm.btn-modern i {
            font-size: 14px; /* 调整按钮图标大小，与文字平衡 */
            margin-right: 4px; /* 图标与文字间距 */
        }

        /* 用户操作按钮 */
        .user-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .user-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .user-btn.btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .user-btn.btn-danger {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }
        /* 新增：小眼睛按钮样式，与其他用户操作按钮风格一致 */
        .user-btn.btn-info {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
            color: white;
        }

        /* 日志区域 */
        .log-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            min-width: 1400px; /* 与表格容器保持一致的宽度 */
            width: 100%; /* 充分利用可用宽度 */
            min-height: 700px; /* 与表格容器保持一致的最小高度 */
        }

        .log-header {
            background: linear-gradient(135deg, var(--secondary-color), #f1f5f9);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-content {
            background: #1a1a1a;
            color: #e5e5e5;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            padding: 20px;
            height: 600px; /* 增大日志窗口高度，从400px增加到600px */
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-content::-webkit-scrollbar {
            width: 12px;
        }

        .log-content::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 6px;
        }

        .log-content::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 6px;
        }

        .log-content::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* 移动端响应式设计 */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
                min-height: 100vh;
            }
            
            .dashboard-header {
                padding: 16px;
                margin-bottom: 16px;
                border-radius: 12px;
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .dashboard-title {
                font-size: 24px;
                justify-content: center;
            }
            
            .title-icon {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .user-actions {
                justify-content: center;
            }
            
            .main-card {
                border-radius: 16px;
            }
            /* 选项卡移动端适配 */
            .nav-tabs {
                padding: 0 16px;
                margin-bottom: 0;
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .nav-tabs .nav-link {
                padding: 12px 16px;
                font-size: 14px;
                white-space: nowrap;
                min-width: auto;
            }
            
            .tab-content {
                padding: 16px;
                min-height: calc(100vh - 200px);
                min-width: auto !important; /* 移动端取消固定最小宽度 */
                overflow-x: visible !important; /* 避免水平滚动导致内容居中后看不见 */
            }
            /* 移动端按钮组 */
            .action-toolbar {
                display: grid !important; /* 两列栅格布局 */
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 12px;
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .btn-modern {
                padding: 12px 20px !important; /* 增大内边距提高可点击性 */
                font-size: 15px !important; /* 增大字体提高可读性 */
                width: 100% !important; /* 强制全宽度按钮 */
                text-align: center !important; /* 居中对齐 */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                border-radius: 10px; /* 增大圆角 */
                display: inline-flex !important; /* 与栅格单元配合 */
                justify-content: center !important; /* 居中图标与文字 */
                align-items: center !important;
                gap: 8px !important;
            }
            
            .btn-modern i {
                font-size: 16px;
                margin-right: 6px;
            }
            /* 移动端表格样式 */
            .table-container {
                border-radius: 8px;
                overflow-x: auto !important; /* 强制启用水平滚动 */
                overflow-y: visible; /* 允许垂直内容可见 */
                -webkit-overflow-scrolling: touch;
                min-width: auto; /* 移除最小宽度限制 */
                width: 100%; /* 充满容器 */
            }
            
            .modern-table {
                min-width: 1100px; /* 进一步增加最小宽度，适应更宽的操作列 */
                font-size: 15px; /* 增大移动端基础字体 */
                border-collapse: separate;
                border-spacing: 0;
            }
            
            /* 移动端表格滚动提示 */
            .table-container::before {
                content: none !important; /* 取消滑动提示 */
                display: none !important;
            }
            
            .modern-table thead th {
                padding: 10px 12px; /* 与桌面端保持一致的高度 */
                font-size: 14px; /* 增大移动端表头字体 */
            }
            
            .modern-table tbody td {
                padding: 10px 12px; /* 与桌面端保持一致的高度 */
                font-size: 15px; /* 增大移动端单元格字体 */
                line-height: 1.3; /* 优化移动端行高 */
            }
            
            .table-actions {
                flex-direction: column;
                gap: 8px;
                min-width: 120px; /* 增大最小宽度 */
                width: 100%;
            }
            /* 服务器配置页面：移动端操作列左对齐（列布局时） */
            #server .table-actions {
                align-items: flex-start;
            }
            
            .btn-sm.btn-modern {
                padding: 10px 16px; /* 增大移动端按钮内边距 */
                font-size: 14px; /* 增大移动端按钮字体 */
                width: 100%; /* 全宽度按钮 */
                text-align: center;
                border-radius: 8px;
            }

            /* 服务状态页：停止服务按钮占满整行 */
            #status .action-toolbar #stopBtn {
                grid-column: 1 / -1;
            }
            /* 移动端模态框样式 */
            .modal-dialog {
                margin: 16px;
                max-width: calc(100vw - 32px);
            }
            
            .modal-content {
                border-radius: 12px;
                border: none;
                box-shadow: var(--shadow-xl);
            }
            
            .modal-header {
                padding: 20px 24px 16px;
                border-bottom: 1px solid var(--border-color);
            }
            
            .modal-body {
                padding: 20px 24px;
            }
            
            .modal-footer {
                padding: 16px 24px 20px;
                border-top: 1px solid var(--border-color);
            }
            
            .form-label {
                margin-bottom: 8px;
                font-weight: 600;
                color: var(--text-color);
            }
            
            .form-control {
                border-radius: 8px;
                border: 1px solid var(--border-color);
                padding: 12px 16px;
                transition: all 0.3s ease;
            }
            
            .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            }
            
            .mb-3 {
                margin-bottom: 16px !important;
            }
            /* 移动端日志区域 */
            .log-container {
                margin-top: 16px;
                border-radius: 8px;
                min-width: auto; /* 移除最小宽度限制 */
                width: 100%;
                overflow-x: auto;
                grid-column: 1 / -1; /* 在两列布局下占满整行 */
            }
            
            .log-header {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .log-content {
                height: 450px; /* 同步增大移动端日志窗口高度 */
                font-size: 12px;
                padding: 16px;
                line-height: 1.5;
            }
            
            .log-content::-webkit-scrollbar {
                width: 8px;
            }
            
            /* 移动端状态指示器 */
            .status-badge {
                font-size: 12px; /* 增大移动端状态徽章字体 */
                padding: 5px 10px; /* 略微增大内边距 */
                width: 100%; /* 全宽度显示 */
                justify-content: center; /* 居中显示 */
                margin-top: 12px; /* 与按钮组分开 */
                grid-column: 1 / -1; /* 在两列布局中占满整行 */
            }

            /* 移动端：表格状态列开关与文字垂直居中 */
            .modern-table tbody td:nth-child(8) .form-check.form-switch {
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            .modern-table tbody td:nth-child(8) .form-check-label {
                display: inline-flex;
                align-items: center;
                margin: 0;
            }
            .modern-table tbody td:nth-child(8) .status-badge {
                width: auto;           /* 在单元格中不占满整行 */
                margin: 0;             /* 与开关贴合显示 */
                padding: 4px 10px;     /* 紧凑一些 */
            }
            
            .status-dot {
                width: 6px;
                height: 6px;
            }
            
            /* 隐藏桌面版特有的细节 */
            .btn-modern:hover {
                transform: none;
            }
            
            .user-btn:hover {
                transform: none;
            }
        }
        
        /* 小屏幕设备适配 */
        @media (max-width: 480px) {
            .main-container {
                padding: 8px;
            }
            
            .dashboard-header {
                padding: 12px;
            }
            
            .dashboard-title {
                font-size: 20px;
            }
            
            .tab-content {
                padding: 12px;
            }
            
            .action-toolbar {
                display: grid !important;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 10px;
                padding: 12px;
            }
            
            .modern-table {
                min-width: 500px;
                font-size: 14px; /* 增大小屏幕设备字体 */
            }
            
            .log-content {
                height: 380px; /* 同步增大小屏幕设备日志窗口高度 */
                font-size: 11px;
            }
        }
        /* 进度条样式 */
        .progress-container {
            margin: 16px 0;
            display: none;
        }
        
        .progress {
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            background: linear-gradient(135deg, var(--success-color), #059669);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
            border-radius: 12px;
        }
        
        .progress-bar-striped {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }
        
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        @keyframes progress-bar-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
        
        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-light);
        }
        /* 动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* 拖拽滚动样式（桌面端） */
        .drag-scroll { cursor: grab; user-select: none; }
        .drag-scroll.dragging { cursor: grabbing; }
        
        /* 加载状态 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    
        /* 页脚样式 */
        .app-footer {
            height: 40px; /* 降低高度，避免需要下滑才可见 */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.92); /* 提升对比度的字体颜色 */
            font-weight: 600;
        }
        .app-footer a {
            color: rgba(255, 255, 255, 0.95); /* 链接默认白色 */
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .app-footer a:hover { color: #ffffff; text-decoration: underline; }
    
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="main-container">
        <!-- 仪表盘头部 -->
        <div class="dashboard-header fade-in-up">
            <div class="dashboard-title">
                <div class="title-icon">
                    <i class="bi bi-router"></i>
                </div>
                FRPC 管理控制台
            </div>
            <div class="user-actions">
                <button class="user-btn btn-info" onclick="toggleSensitive()" id="toggleSensitiveBtn" title="显示敏感信息">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="user-btn btn-warning" onclick="openChangePasswordModal()" title="修改密码">
                    <i class="bi bi-key"></i>
                </button>
                <a href="{{ url_for('auth.logout') }}" class="user-btn btn-danger" title="退出登录">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </div>

        <!-- 主内容卡片 -->
        <div class="main-card fade-in-up">
            <ul class="nav nav-tabs" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="server-tab" data-bs-toggle="tab" data-bs-target="#server" type="button" role="tab">
                        <i class="bi bi-server"></i> 服务器配置
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="client-tab" data-bs-toggle="tab" data-bs-target="#client" type="button" role="tab">
                        <i class="bi bi-laptop"></i> 客户端配置
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab">
                        <i class="bi bi-activity"></i> 服务状态
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="configTabsContent">
                <!-- 服务器配置页面 -->
                <div class="tab-pane fade show active" id="server" role="tabpanel">
                    <div class="action-toolbar">
                        <button class="btn btn-primary btn-modern" onclick="openServerModal()">
                            <i class="bi bi-plus-circle"></i>
                            添加配置
                        </button>
                        <button class="btn btn-success btn-modern" onclick="saveConfig()">
                            <i class="bi bi-check-circle"></i>
                            保存配置
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-server"></i> 服务器地址</th>
                                    <th><i class="bi bi-diagram-3"></i> 端口</th>
                                    <th><i class="bi bi-globe"></i> Web服务</th>
                                    <th><i class="bi bi-shield-check"></i> 认证方式</th>
                                    <th><i class="bi bi-gear"></i> 操作</th>
                                </tr>
                            </thead>
                            <tbody id="serverTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- 客户端配置页面 -->
                <div class="tab-pane fade" id="client" role="tabpanel">
                    <div class="action-toolbar">
                        <button class="btn btn-primary btn-modern" onclick="openClientModal()">
                            <i class="bi bi-plus-circle"></i>
                            添加配置
                        </button>
                        <button class="btn btn-success btn-modern" onclick="saveConfig()">
                            <i class="bi bi-check-circle"></i>
                            保存配置
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-tag"></i> 名称</th>
                                    <th><i class="bi bi-diagram-2"></i> 类型</th>
                                    <th><i class="bi bi-hdd-network"></i> 本地IP</th>
                                    <th><i class="bi bi-plug"></i> 本地端口</th>
                                    <th><i class="bi bi-arrow-right-circle"></i> 远程端口</th>
                                    <th><i class="bi bi-globe"></i> 域名</th>
                                    <th><i class="bi bi-signpost"></i> 路由</th>
                                    <th><i class="bi bi-power"></i> 状态</th>
                                    <th><i class="bi bi-gear"></i> 操作</th>
                                </tr>
                            </thead>
                            <tbody id="clientTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <!-- 服务状态页面 -->
                <div class="tab-pane fade" id="status" role="tabpanel">
                    <div class="action-toolbar">
                        <button class="btn btn-info btn-modern" onclick="confirmDownloadFrpc()">
                            <i class="bi bi-download"></i>
                            下载 FRPC
                        </button>
                        <button class="btn btn-primary btn-modern" onclick="openConfigManager()">
                            <i class="bi bi-gear"></i>
                            配置管理
                        </button>
                        <button class="btn btn-success btn-modern" onclick="startService()" id="startBtn">
                            <i class="bi bi-play-fill"></i>
                            启动服务
                        </button>
                        <button class="btn btn-warning btn-modern" onclick="restartService()" id="restartBtn">
                            <i class="bi bi-arrow-clockwise"></i>
                            重启服务
                        </button>
                        <button class="btn btn-danger btn-modern" onclick="stopService()" id="stopBtn">
                            <i class="bi bi-stop-fill"></i>
                            停止服务
                        </button>
                        <div class="status-badge offline" id="statusIndicator">
                            <span class="status-dot offline"></span>
                            <span class="status-text">FRPC 状态</span>
                        </div>
                    </div>
                    
                    <div class="log-container">
                        <div class="log-header">
                            <div>
                                <i class="bi bi-journal-text"></i>
                                服务日志
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="fetchLog()" title="刷新日志">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearLog()" title="清空日志">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="log-content" id="logContent">正在加载日志...</div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="app-footer">
        <div>Powered By</div>
        <a href="https://github.com/xirankj/frpc-web" target="_blank" rel="noopener noreferrer">
            <i class="bi bi-github"></i>
            <span>frpc-web</span>
        </a>
    </footer>

    <!-- 服务器配置弹窗 -->
    <div class="modal fade" id="serverModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="serverFormModal" onsubmit="return submitServerModal()">
            <div class="modal-header">
              <h5 class="modal-title">服务器配置</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="serverEditIndex">
              
              <!-- 基本配置 -->
              <div class="mb-3">
                <label class="form-label">服务器地址 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="modalServerAddr" required>
                <small class="form-text text-muted">服务端监听地址，默认 0.0.0.0</small>
              </div>
              <div class="mb-3">
                <label class="form-label">端口 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="modalServerPort" required>
                <small class="form-text text-muted">服务端监听端口，默认 7000</small>
              </div>

              <!-- Web服务配置 -->
              <div class="mb-3">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="enableWebServer" onchange="toggleWebServer()">
                  <label class="form-check-label" for="enableWebServer">启用 Web 服务</label>
                </div>
                <div id="webServerConfig" style="display: none;">
                  <div class="mb-3">
                    <label class="form-label">Web地址</label>
                    <input type="text" class="form-control" id="modalWebAddr">
                    <small class="form-text text-muted">Web服务监听地址</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Web端口</label>
                    <input type="number" class="form-control" id="modalWebPort">
                    <small class="form-text text-muted">Web服务监听端口</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">用户名</label>
                    <input type="text" class="form-control" id="modalWebUser">
                    <small class="form-text text-muted">Web服务登录用户名</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">密码</label>
                    <input type="password" class="form-control" id="modalWebPassword">
                    <small class="form-text text-muted">Web服务登录密码</small>
                  </div>
                </div>
              </div>

              <!-- 认证配置 -->
              <div class="mb-3">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="enableAuth" onchange="toggleAuth()">
                  <label class="form-check-label" for="enableAuth">启用认证</label>
                </div>
                <div id="authConfig" style="display: none;">
                  <div class="mb-3">
                    <label class="form-label">认证方式</label>
                    <select class="form-control" id="modalAuthMethod">
                      <option value="token">Token</option>
                      <option value="oidc">OIDC</option>
                    </select>
                    <small class="form-text text-muted">认证方式，默认为 token</small>
                  </div>
                  <div class="mb-3" id="tokenAuthConfig">
                    <label class="form-label">Token</label>
                    <input type="text" class="form-control" id="modalAuthToken">
                    <small class="form-text text-muted">认证令牌，客户端需要设置相同的值</small>
                  </div>
                  <div class="mb-3" id="oidcAuthConfig" style="display: none;">
                    <label class="form-label">Issuer</label>
                    <input type="text" class="form-control" id="modalAuthIssuer">
                    <small class="form-text text-muted">OIDC 发行者地址</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 客户端配置弹窗 -->
    <div class="modal fade" id="clientModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="clientFormModal" onsubmit="return submitClientModal()">
            <div class="modal-header">
              <h5 class="modal-title">客户端配置</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="clientEditIndex">
              <div class="mb-3">
                <label class="form-label">名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="modalClientName" required>
                <small class="form-text text-muted">代理名称，必填</small>
              </div>
              <div class="mb-3">
                <label class="form-label">类型 <span class="text-danger">*</span></label>
                <select class="form-control" id="modalClientType" required onchange="toggleFields()">
                  <option value="tcp">TCP</option>
                  <option value="udp">UDP</option>
                  <option value="http">HTTP</option>
                  <option value="https">HTTPS</option>
                  <option value="stcp">STCP</option>
                  <option value="sudp">SUDP</option>
                  <option value="xtcp">XTCP</option>
                </select>
                <small class="form-text text-muted">代理类型，必填</small>
              </div>
              <div class="mb-3">
                <label class="form-label">本地IP <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="modalClientLocalIP" required>
                <small class="form-text text-muted">本地服务IP，必填</small>
              </div>
              <div class="mb-3">
                <label class="form-label">本地端口 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="modalClientLocalPort" required>
                <small class="form-text text-muted">本地服务端口，必填</small>
              </div>
              <div class="mb-3 remote-port-field">
                <label class="form-label">远程端口</label>
                <input type="number" class="form-control" id="modalClientRemotePort">
                <small class="form-text text-muted">远程服务端口，TCP/UDP类型必填</small>
              </div>
              <div class="mb-3 domain-field" style="display: none;">
                <label class="form-label">自定义域名</label>
                <input type="text" class="form-control" id="modalClientDomains">
                <small class="form-text text-muted">HTTP/HTTPS类型可选，多个域名用逗号分隔</small>
              </div>
              <div class="mb-3 domain-field" style="display: none;">
                <label class="form-label">路由</label>
                <input type="text" class="form-control" id="modalClientRoute">
                <small class="form-text text-muted">HTTP/HTTPS类型可选，URL路由规则</small>
              </div>
              <div class="mb-3 domain-field" style="display: none;">
                <label class="form-label">BasicAuth</label>
                <input type="text" class="form-control" id="modalClientBasicAuth">
                <small class="form-text text-muted">HTTP/HTTPS类型可选，格式：用户名:密码</small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="submit" class="btn btn-primary">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 修改密码对话框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="changePasswordForm" onsubmit="return handleChangePassword(event)">
                    <div class="modal-header">
                        <h5 class="modal-title">修改密码</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">当前密码</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密码</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">确认修改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 确认删除对话框 -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmDeleteMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">删除</button>
            </div>
        </div>
</div>
</div>

<!-- 操作结果对话框 -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">操作结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="resultModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
            </div>
        </div>
</div>
</div>

<!-- 通用确认对话框 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">确认操作</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmModalOkBtn">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 下载确认对话框 -->
<div class="modal fade" id="downloadConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">下载 frpc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>是否下载 frpc 程序？</p>
                <p class="text-muted">下载后将自动解压到根目录。</p>
                <div class="progress-container" id="downloadProgressContainer">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="downloadProgressText"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="cancelDownloadBtn" style="display: none;" onclick="cancelDownload()">取消下载</button>
                <button type="button" class="btn btn-primary" onclick="checkAndDownloadFrpc()" id="startDownloadBtn">确认下载</button>
            </div>
        </div>
    </div>
</div>

<!-- 配置管理弹窗 -->
<div class="modal fade" id="configManagerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">frpc.json 配置管理</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">导入本地 frpc.json：</label>
          <input type="file" id="importConfigFile" accept="application/json,.json" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">或粘贴配置内容：</label>
          <textarea id="configTextarea" class="form-control" rows="12" placeholder="粘贴或编辑 frpc.json 配置"></textarea>
          <div id="configFormatTip" class="form-text text-danger"></div>
        </div>
        <div class="mb-3 d-flex gap-2">
          <button class="btn btn-outline-primary" type="button" onclick="exportConfigFile()">导出配置</button>
          <button class="btn btn-outline-secondary" type="button" onclick="readConfigFile()">读取当前配置</button>
          <button class="btn btn-outline-success" type="button" onclick="saveConfigFile()">保存配置</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
// 全局 fetch 拦截器：若发现 401/403，自动跳转至登录页
(function() {
  const _fetch = window.fetch;
  window.fetch = function(input, init) {
    return _fetch(input, init).then(resp => {
      if (resp && (resp.status === 401 || resp.status === 403)) {
        try { console.warn('未授权，自动跳转登录'); } catch(e){}
        window.location.href = '/login';
        // 抛出错误，阻止后续 then 继续处理
        throw new Error('未授权或会话已过期');
      }
      return resp;
    }).catch(err => { throw err; });
  };
})();

// 敏感信息显示/隐藏
let hideSensitive = false; // 默认显示
function maskSensitive(value) {
    if (value === undefined || value === null || value === '') return '-';
    const s = String(value);
    const len = Math.max(4, Math.min(12, s.length));
    return '*'.repeat(len);
}
function fmtSensitive(value) { return hideSensitive ? maskSensitive(value) : value; }
function updateSensitiveBtn() {
    const btn = document.getElementById('toggleSensitiveBtn');
    if (!btn) return;
    const icon = btn.querySelector('i');
    if (hideSensitive) {
        icon.className = 'bi bi-eye';
        btn.title = '显示敏感信息';
    } else {
        icon.className = 'bi bi-eye-slash';
        btn.title = '隐藏敏感信息';
    }
}
function toggleSensitive() {
    hideSensitive = !hideSensitive;
    updateSensitiveBtn();
    try { renderServerTable(); } catch(e) {}
    try { renderClientTable(); } catch(e) {}
}

document.addEventListener('DOMContentLoaded', () => {
    updateSensitiveBtn();
});

let serverConfigs = [];
let clientConfigs = [];
let ws = null;  // WebSocket 连接
let wsRetryCount = 0;  // 重试次数
const MAX_RETRY_COUNT = 3;  // 最大重试次数
const RETRY_DELAY = 1000;  // 重试延迟（毫秒）
let wsLogTimer = null;
let wsReconnectTimer = null; // WebSocket 重连定时器
let wsShouldReconnect = true; // 是否允许自动重连

// 添加输入验证函数
function validateIP(ip) {
    const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipv4Regex.test(ip)) {
        return 'IP 地址格式不正确';
    }
    
    const parts = ip.split('.');
    for (const part of parts) {
        const num = parseInt(part);
        if (num < 0 || num > 255) {
            return 'IP 地址数值超出范围';
        }
    }
    return '';
}

function validatePort(port) {
    const num = parseInt(port);
    if (isNaN(num)) {
        return '端口必须是数字';
    }
    if (num < 1 || num > 65535) {
        return '端口范围必须在 1-65535 之间';
    }
    return '';
}

function validateDomain(domain) {
    // 域名格式：example.com 或 sub.example.com
    const domainRegex = /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/;
    if (!domainRegex.test(domain)) {
        return '域名格式不正确';
    }
    return '';
}

function validateDomains(domains) {
    if (!domains) return '';
    const domainList = domains.split(',').map(d => d.trim());
    for (const domain of domainList) {
        const error = validateDomain(domain);
        if (error) {
            return error;
        }
    }
    return '';
}

// 修改密码
async function handleChangePassword(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        alert('请填写所有密码字段');
        return false;
    }
    
    if (newPassword !== confirmPassword) {
        alert('两次输入的新密码不一致');
        return false;
    }
    
    try {
        const response = await fetch('/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // 关闭修改密码对话框
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
            alert(data.message);
            // 重定向到登录页面
            window.location.href = '/login';
        } else {
            alert(data.message || '密码修改失败');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('密码修改失败，请重试');
    }
    return false;
}

// 加载配置
async function loadConfig() {
    try {
        const response = await fetch('/config.json');
        if (!response.ok) {
            if (response.status === 401) {
                // 未登录，重定向到登录页面
                window.location.href = '/login';
                return;
            }
            throw new Error('加载配置失败');
        }
        const config = await response.json();
        // 服务器配置（只支持单条，便于扩展为多条）
        serverConfigs = [{
            serverAddr: config.serverAddr,
            serverPort: config.serverPort,
            webServer: config.webServer,
            auth: config.auth
        }];
        // 客户端配置（包含启用状态）
        clientConfigs = config.proxies || [];
        renderServerTable();
        renderClientTable();
    } catch (error) {
        console.error('Error:', error);
        if (error.message.includes('Unexpected token')) {
            // 如果返回的不是JSON，可能是未登录
            window.location.href = '/login';
        } else {
            alert('加载配置失败，请重试');
        }
    }
}

function renderServerTable() {
    const tbody = document.getElementById('serverTableBody');
    tbody.innerHTML = '';
    serverConfigs.forEach((cfg, idx) => {
        const webStatus = cfg.webServer ? 
            `<span class="status-badge online"><span class="status-dot online"></span>已启用</span>` : 
            `<span class="status-badge offline"><span class="status-dot offline"></span>未启用</span>`;
        const authStatus = cfg.auth ? 
            `<span class="status-badge online"><span class="status-dot online"></span>${cfg.auth.method}</span>` : 
            `<span class="status-badge offline"><span class="status-dot offline"></span>未启用</span>`;
        
        tbody.innerHTML += `<tr>
            <td><strong>${fmtSensitive(cfg.serverAddr)}</strong></td>
            <td><code>${fmtSensitive(cfg.serverPort)}</code></td>
            <td>${webStatus}</td>
            <td>${authStatus}</td>
            <td>
                <div class="table-actions">
                    <button class='btn btn-sm btn-primary btn-modern' onclick='editServer(${idx})'>
                        <i class="bi bi-pencil"></i> 编辑
                    </button>
                    <button class='btn btn-sm btn-danger btn-modern' onclick='deleteServer(${idx})'>
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            </td>
        </tr>`;
    });
}

// 根据代理类型显示/隐藏字段
function toggleFields() {
    const type = document.getElementById('modalClientType').value;
    const domainFields = document.querySelectorAll('.domain-field');
    const remotePortField = document.querySelector('.remote-port-field');
    
    // 重置所有字段的显示状态
    domainFields.forEach(field => field.style.display = 'none');
    remotePortField.style.display = 'block';
    
    // 根据类型显示相应字段
    if (type === 'http' || type === 'https') {
        domainFields.forEach(field => field.style.display = 'block');
        remotePortField.style.display = 'none';
    } else if (type === 'tcp' || type === 'udp') {
        remotePortField.style.display = 'block';
    } else {
        remotePortField.style.display = 'none';
    }
}

// 修改客户端配置提交函数
function submitClientModal() {
    const idx = document.getElementById('clientEditIndex').value;
    const type = document.getElementById('modalClientType').value;
    
    const localIP = document.getElementById('modalClientLocalIP').value;
    const localPort = document.getElementById('modalClientLocalPort').value;
    
    // 验证本地 IP
    const ipError = validateIP(localIP);
    if (ipError) {
        showResultModal('验证失败', `本地IP: ${ipError}`);
        return false;
    }
    
    // 验证本地端口
    const portError = validatePort(localPort);
    if (portError) {
        showResultModal('验证失败', `本地端口: ${portError}`);
        return false;
    }
    
    const cfg = {
        name: document.getElementById('modalClientName').value,
        type: type,
        localIP: localIP,
        localPort: parseInt(localPort)
    };
    
    // 根据类型添加可选字段
    if (type === 'tcp' || type === 'udp') {
        const remotePort = document.getElementById('modalClientRemotePort').value;
        const remotePortError = validatePort(remotePort);
        if (remotePortError) {
            showResultModal('验证失败', `远程端口: ${remotePortError}`);
            return false;
        }
        cfg.remotePort = parseInt(remotePort);
    }
    
    if (type === 'http' || type === 'https') {
        const domains = document.getElementById('modalClientDomains').value;
        const domainsError = validateDomains(domains);
        if (domainsError) {
            showResultModal('验证失败', `自定义域名: ${domainsError}`);
            return false;
        }
        if (domains) {
            cfg.customDomains = domains.split(',').map(d => d.trim());
        }
        
        const route = document.getElementById('modalClientRoute').value;
        if (route) {
            cfg.route = route;
        }
        
        const basicAuth = document.getElementById('modalClientBasicAuth').value;
        if (basicAuth) {
            cfg.basicAuth = basicAuth;
        }
    }
    
    if (idx === '') {
        clientConfigs.push(cfg);
    } else {
        clientConfigs[idx] = cfg;
    }
    
    renderClientTable();
    bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
    return false;
}

function renderClientTable() {
    const tbody = document.getElementById('clientTableBody');
    tbody.innerHTML = '';
    clientConfigs.forEach((cfg, idx) => {
        const typeClass = {
            'tcp': 'primary',
            'udp': 'info', 
            'http': 'success',
            'https': 'warning'
        }[cfg.type] || 'secondary';
        
        const enabledStatus = cfg.enabled !== false ? 
            `<span class="status-badge online"><span class="status-dot online"></span>已启用</span>` :
            `<span class="status-badge offline"><span class="status-dot offline"></span>已禁用</span>`;
        
        tbody.innerHTML += `<tr>
            <td><strong>${cfg.name || '-'}</strong></td>
            <td><span class="badge bg-${typeClass}">${cfg.type ? cfg.type.toUpperCase() : '-'}</span></td>
            <td><code>${fmtSensitive(cfg.localIP)}</code></td>
            <td><code>${fmtSensitive(cfg.localPort)}</code></td>
            <td><code>${hideSensitive ? fmtSensitive(cfg.remotePort) : (cfg.remotePort ?? '-')}</code></td>
            <td>${(function(){ const joined = cfg.customDomains ? cfg.customDomains.join(', ') : ''; return hideSensitive ? maskSensitive(joined) : (joined || '-'); })()}</td>
            <td><code>${cfg.route || '-'}</code></td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" 
                           id="enable_${idx}" ${cfg.enabled !== false ? 'checked' : ''} 
                           onchange="toggleClientEnabled(${idx}, this.checked)">
                    <label class="form-check-label" for="enable_${idx}">
                        ${enabledStatus}
                    </label>
                </div>
            </td>
            <td>
                <div class="table-actions">
                    <button class='btn btn-sm btn-primary btn-modern' onclick='editClient(${idx})'>
                        <i class="bi bi-pencil"></i> 编辑
                    </button>
                    <button class='btn btn-sm btn-danger btn-modern' onclick='deleteClient(${idx})'>
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            </td>
        </tr>`;
    });
}

// 切换Web服务配置显示
function toggleWebServer() {
    const webServerConfig = document.getElementById('webServerConfig');
    const isChecked = document.getElementById('enableWebServer').checked;
    webServerConfig.style.display = isChecked ? 'block' : 'none';
    
    // 如果未选中，清空相关字段
    if (!isChecked) {
        document.getElementById('modalWebAddr').value = '';
        document.getElementById('modalWebPort').value = '';
        document.getElementById('modalWebUser').value = '';
        document.getElementById('modalWebPassword').value = '';
    }
}

// 切换认证配置显示
function toggleAuth() {
    const authConfig = document.getElementById('authConfig');
    const isChecked = document.getElementById('enableAuth').checked;
    authConfig.style.display = isChecked ? 'block' : 'none';
    
    // 如果未选中，清空相关字段
    if (!isChecked) {
        document.getElementById('modalAuthMethod').value = 'token';
        document.getElementById('modalAuthToken').value = '';
        document.getElementById('modalAuthIssuer').value = '';
    }
}

// 切换认证方式配置
function toggleAuthMethod() {
    const method = document.getElementById('modalAuthMethod').value;
    document.getElementById('tokenAuthConfig').style.display = method === 'token' ? 'block' : 'none';
    document.getElementById('oidcAuthConfig').style.display = method === 'oidc' ? 'block' : 'none';
    
    // 切换认证方式时清空另一个方式的字段
    if (method === 'token') {
        document.getElementById('modalAuthIssuer').value = '';
    } else {
        document.getElementById('modalAuthToken').value = '';
    }
}

function openServerModal(editIdx = null) {
    document.getElementById('serverFormModal').reset();
    document.getElementById('serverEditIndex').value = editIdx !== null ? editIdx : '';
    
    // 默认关闭可选配置
    document.getElementById('enableWebServer').checked = false;
    document.getElementById('enableAuth').checked = false;
    document.getElementById('webServerConfig').style.display = 'none';
    document.getElementById('authConfig').style.display = 'none';
    
    if (editIdx !== null) {
        const cfg = serverConfigs[editIdx];
        document.getElementById('modalServerAddr').value = cfg.serverAddr || '';
        document.getElementById('modalServerPort').value = cfg.serverPort || '';
        
        // Web服务配置
        const hasWebServer = cfg.webServer && Object.keys(cfg.webServer).length > 0;
        document.getElementById('enableWebServer').checked = hasWebServer;
        if (hasWebServer) {
            document.getElementById('modalWebAddr').value = cfg.webServer.addr || '';
            document.getElementById('modalWebPort').value = cfg.webServer.port || '';
            document.getElementById('modalWebUser').value = cfg.webServer.user || '';
            document.getElementById('modalWebPassword').value = cfg.webServer.password || '';
        }
        
        // 认证配置
        const hasAuth = cfg.auth && Object.keys(cfg.auth).length > 0;
        document.getElementById('enableAuth').checked = hasAuth;
        if (hasAuth) {
            document.getElementById('modalAuthMethod').value = cfg.auth.method || 'token';
            if (cfg.auth.method === 'token') {
                document.getElementById('modalAuthToken').value = cfg.auth.token || '';
            } else if (cfg.auth.method === 'oidc') {
                document.getElementById('modalAuthIssuer').value = cfg.auth.oidc?.issuer || '';
            }
        }
        
        // 显示/隐藏相关配置
        toggleWebServer();
        toggleAuth();
        toggleAuthMethod();
    }
    
    new bootstrap.Modal(document.getElementById('serverModal')).show();
}

// 修改服务器配置提交函数
function submitServerModal() {
    const serverAddr = document.getElementById('modalServerAddr').value;
    const serverPort = document.getElementById('modalServerPort').value;
    
    // 验证服务器地址
    const addrError = validateIP(serverAddr);
    if (addrError) {
        showResultModal('验证失败', `服务器地址: ${addrError}`);
        return false;
    }
    
    // 验证服务器端口
    const portError = validatePort(serverPort);
    if (portError) {
        showResultModal('验证失败', `服务器端口: ${portError}`);
        return false;
    }
    
    const idx = document.getElementById('serverEditIndex').value;
    const cfg = {
        serverAddr: serverAddr,
        serverPort: parseInt(serverPort)
    };
    
    // Web服务配置
    if (document.getElementById('enableWebServer').checked) {
        const webAddr = document.getElementById('modalWebAddr').value;
        const webPort = document.getElementById('modalWebPort').value;
        
        // 验证 Web 服务地址
        const webAddrError = validateIP(webAddr);
        if (webAddrError) {
            showResultModal('验证失败', `Web服务地址: ${webAddrError}`);
            return false;
        }
        
        // 验证 Web 服务端口
        const webPortError = validatePort(webPort);
        if (webPortError) {
            showResultModal('验证失败', `Web服务端口: ${webPortError}`);
            return false;
        }
        
        cfg.webServer = {
            addr: webAddr,
            port: parseInt(webPort),
            user: document.getElementById('modalWebUser').value,
            password: document.getElementById('modalWebPassword').value
        };
    }
    
    // 认证配置
    if (document.getElementById('enableAuth').checked) {
        const method = document.getElementById('modalAuthMethod').value;
        cfg.auth = {
            method: method
        };
        if (method === 'token') {
            cfg.auth.token = document.getElementById('modalAuthToken').value;
        } else if (method === 'oidc') {
            cfg.auth.oidc = {
                issuer: document.getElementById('modalAuthIssuer').value
            };
        }
    }
    
    if (idx === '') {
        serverConfigs.push(cfg);
    } else {
        serverConfigs[idx] = cfg;
    }
    
    renderServerTable();
    bootstrap.Modal.getInstance(document.getElementById('serverModal')).hide();
    return false;
}

function editServer(idx) { openServerModal(idx); }
function deleteServer(idx) {
    showConfirmDeleteModal('确定要删除该服务器配置吗？', () => {
        serverConfigs.splice(idx, 1);
        renderServerTable();
        showResultModal('删除成功', '服务器配置已删除');
    });
}

// 客户端配置弹窗
function openClientModal(editIdx = null) {
    document.getElementById('clientFormModal').reset();
    document.getElementById('clientEditIndex').value = editIdx !== null ? editIdx : '';
    
    // 设置默认类型为 tcp
    document.getElementById('modalClientType').value = 'tcp';
    // 根据默认类型显示相应字段
    toggleFields();
    
    if (editIdx !== null) {
        const cfg = clientConfigs[editIdx];
        document.getElementById('modalClientName').value = cfg.name || '';
        document.getElementById('modalClientType').value = cfg.type || 'tcp';
        document.getElementById('modalClientLocalIP').value = cfg.localIP || '';
        document.getElementById('modalClientLocalPort').value = cfg.localPort || '';
        document.getElementById('modalClientRemotePort').value = cfg.remotePort || '';
        document.getElementById('modalClientDomains').value = cfg.customDomains ? cfg.customDomains.join(',') : '';
        document.getElementById('modalClientRoute').value = cfg.route || '';
        document.getElementById('modalClientBasicAuth').value = cfg.basicAuth || '';
        
        // 根据配置类型显示相应字段
        toggleFields();
    }
    new bootstrap.Modal(document.getElementById('clientModal')).show();
}
function editClient(idx) { openClientModal(idx); }
function deleteClient(idx) {
    showConfirmDeleteModal('确定要删除该客户端配置吗？', () => {
        clientConfigs.splice(idx, 1);
        renderClientTable();
        showResultModal('删除成功', '客户端配置已删除');
    });
}

// 保存配置
async function saveConfig() {
    try {
        if (serverConfigs.length === 0) throw new Error('请至少添加一个服务器配置');
        const server = serverConfigs[0];
        
        // 保存到 config.json（包含所有配置，包括启用和未启用的）
        const config = {
            serverAddr: server.serverAddr,
            serverPort: server.serverPort,
            webServer: server.webServer,
            auth: server.auth,
            proxies: clientConfigs  // 包含所有客户端配置，包括启用状态
        };
        
        // 保存到 config.json
        const configResponse = await fetch('/save-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        if (!configResponse.ok) throw new Error('保存配置失败');
        const configResult = await configResponse.json();
        
        // 检查是否有启用的客户端配置
        const enabledProxies = clientConfigs.filter(proxy => proxy.enabled !== false);
        
        if (enabledProxies.length > 0) {
            // 保存到 frpc.json（只包含启用的配置，不包含 enabled 字段）
            const frpcConfig = {
                serverAddr: server.serverAddr,
                serverPort: server.serverPort,
                webServer: server.webServer,
                auth: server.auth,
                proxies: enabledProxies.map(proxy => {
                    const { enabled, ...rest } = proxy;
                    return rest;
                })
            };
            
            const frpcResponse = await fetch('/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(frpcConfig)
            });
            
            if (!frpcResponse.ok) throw new Error('保存 frpc 配置失败');
            const frpcResult = await frpcResponse.json();
            
            if (frpcResult.status === 'success') {
                showResultModal('保存成功', '配置已成功保存');
            } else {
                throw new Error(frpcResult.message || '保存失败');
            }
        } else {
            // 如果没有启用的配置，删除 frpc.json
            const deleteResponse = await fetch('/delete-frpc-config', {
                method: 'POST'
            });
            
            if (!deleteResponse.ok) throw new Error('删除 frpc 配置失败');
            
            showResultModal('保存成功', '配置已保存，但没有启用的客户端配置');
        }
    } catch (e) {
        showResultModal('保存失败', '保存配置失败：' + e.message);
    }
}

// 显示操作结果对话框
function showResultModal(title, message, onClose) {
    const modalEl = document.getElementById('resultModal');
    document.getElementById('resultModalTitle').textContent = title;
    document.getElementById('resultModalMessage').textContent = message;

    // 计算当前已显示模态框的最高 z-index，使结果弹窗位于最上层
    const openModals = Array.from(document.querySelectorAll('.modal.show'));
    let baseZ = 1050;
    openModals.forEach(m => {
        const z = parseInt(window.getComputedStyle(m).zIndex || '1050', 10);
        if (!isNaN(z)) baseZ = Math.max(baseZ, z);
    });
    modalEl.style.zIndex = (baseZ + 20).toString();
    const onShown = () => {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        const backdropEl = backdrops[backdrops.length - 1];
        if (backdropEl) backdropEl.style.zIndex = (baseZ + 10).toString();
    };
    modalEl.addEventListener('shown.bs.modal', onShown, { once: true });

    const modal = new bootstrap.Modal(modalEl, { backdrop: true, focus: true });
    if (typeof onClose === 'function') {
        const handler = () => {
            modalEl.removeEventListener('hidden.bs.modal', handler);
            try { onClose(); } catch (e) { console.error(e); }
        };
        modalEl.addEventListener('hidden.bs.modal', handler, { once: true });
    }
    // 关闭后清理 z-index，避免下次叠加
    modalEl.addEventListener('hidden.bs.modal', () => { modalEl.style.zIndex = ''; }, { once: true });
    modal.show();
}

// 全局替换浏览器 alert 为站内弹窗
(function(){
    const nativeAlert = window.alert.bind(window);
    window.alert = function(msg){
        try { showResultModal('提示', String(msg)); }
        catch(e) { nativeAlert(String(msg)); }
    };
})();

// 显示确认删除对话框
function showConfirmDeleteModal(message, callback) {
    document.getElementById('confirmDeleteMessage').textContent = message;
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const modalEl = document.getElementById('confirmDeleteModal');

    // 置顶该模态框
    const openModals = Array.from(document.querySelectorAll('.modal.show'));
    let baseZ = 1050;
    openModals.forEach(m => {
        const z = parseInt(window.getComputedStyle(m).zIndex || '1050', 10);
        if (!isNaN(z)) baseZ = Math.max(baseZ, z);
    });
    modalEl.style.zIndex = (baseZ + 20).toString();
    const onShown = () => {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        const backdropEl = backdrops[backdrops.length - 1];
        if (backdropEl) backdropEl.style.zIndex = (baseZ + 10).toString();
    };
    modalEl.addEventListener('shown.bs.modal', onShown, { once: true });

    const modal = new bootstrap.Modal(modalEl, { backdrop: true, focus: true });
    
    // 移除之前的事件监听器
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    // 添加新的事件监听器
    newConfirmBtn.addEventListener('click', () => {
        modal.hide();
        callback();
    });
    
    modalEl.addEventListener('hidden.bs.modal', () => { modalEl.style.zIndex = ''; }, { once: true });
    modal.show();
}

// 通用确认对话框
function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmModalTitle').textContent = title || '确认';
    document.getElementById('confirmModalMessage').textContent = message || '';
    const okBtn = document.getElementById('confirmModalOkBtn');
    const modalEl = document.getElementById('confirmModal');

    // 计算当前已显示模态框的最高 z-index，确保确认对话框覆盖在最上层
    const openModals = Array.from(document.querySelectorAll('.modal.show'));
    let baseZ = 1050; // Bootstrap 默认 modal z-index
    openModals.forEach(m => {
        const z = parseInt(window.getComputedStyle(m).zIndex || '1050', 10);
        if (!isNaN(z)) baseZ = Math.max(baseZ, z);
    });
    // 设置确认框与其 backdrop 的更高 z-index
    modalEl.style.zIndex = (baseZ + 20).toString();
    const onShown = () => {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        const backdropEl = backdrops[backdrops.length - 1];
        if (backdropEl) backdropEl.style.zIndex = (baseZ + 10).toString();
    };
    modalEl.addEventListener('shown.bs.modal', onShown, { once: true });

    const modal = new bootstrap.Modal(modalEl, { backdrop: true, focus: true });

    const onOk = () => {
        okBtn.removeEventListener('click', onOk);
        modal.hide();
        if (typeof onConfirm === 'function') onConfirm();
    };

    okBtn.addEventListener('click', onOk, { once: true });
    modalEl.addEventListener('hidden.bs.modal', () => {
        try { okBtn.removeEventListener('click', onOk); } catch(e){}
        // 关闭后清理样式，避免下次叠加
        modalEl.style.zIndex = '';
    }, { once: true });

    modal.show();
}

// 打开修改密码对话框
function openChangePasswordModal() {
    document.getElementById('changePasswordForm').reset();
    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
}

// 显示下载确认对话框
function confirmDownloadFrpc() {
    // 重置进度 UI
    const progressContainer = document.getElementById('downloadProgressContainer');
    const progressBar = document.querySelector('.progress-bar');
    const progressText = document.getElementById('downloadProgressText');
    const startDownloadBtn = document.getElementById('startDownloadBtn');
    const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
    if (progressContainer) progressContainer.style.display = 'none';
    if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
    }
    if (progressText) progressText.textContent = '';
    if (startDownloadBtn) startDownloadBtn.style.display = 'block';
    if (cancelDownloadBtn) cancelDownloadBtn.style.display = 'none';

    new bootstrap.Modal(document.getElementById('downloadConfirmModal')).show();
}

// WebSocket 连接管理
function connectWebSocket() {
    return new Promise((resolve) => {
        // 已连接则直接返回
        if (ws && ws.readyState === WebSocket.OPEN) {
            console.log('WebSocket 已连接');
            resolve(ws);
            return;
        }
        // 若正在连接，先关闭后重连
        if (ws && ws.readyState === WebSocket.CONNECTING) {
            try { ws.close(); } catch(e){}
        }

        console.log('正在建立 WebSocket 连接...');
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
        console.log('WebSocket URL:', wsUrl);

        // 创建 WebSocket 连接
        ws = new WebSocket(wsUrl);
        wsShouldReconnect = true; // 默认允许自动重连

        ws.onopen = function() {
            console.log('WebSocket 连接已建立');
            wsRetryCount = 0;  // 重置重试计数
            if (wsReconnectTimer) { clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }
            resolve(ws);
        };

        ws.onclose = function(event) {
            console.log('WebSocket 连接已关闭，代码:', event.code, '原因:', event.reason);
            if (!wsShouldReconnect) {
                console.log('本次关闭为主动关闭，不进行重连。');
                return;
            }
            // 静默重连，不弹窗
            wsRetryCount++;
            const delay = Math.min(RETRY_DELAY * wsRetryCount, 5000);
            wsReconnectTimer = setTimeout(() => {
                console.log(`尝试重新连接 (第 ${wsRetryCount} 次)...`);
                connectWebSocket();
            }, delay);
        };

        ws.onerror = function(error) {
            console.warn('WebSocket 错误:', error);
            // 错误由 onclose 触发重连
        };

        // 统一的消息处理
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                switch(data.type) {
                    case 'log': {
                        const logOutput = document.getElementById('logContent');
                        if (logOutput) {
                            logOutput.textContent = data.content || '暂无日志';
                            logOutput.scrollTop = logOutput.scrollHeight;
                            if (!logOutput.textContent || logOutput.textContent === '暂无日志') {
                                logOutput.innerText = data.content || '暂无日志';
                            }
                            if (!logOutput.innerText || logOutput.innerText === '暂无日志') {
                                logOutput.innerHTML = (data.content || '暂无日志').replace(/\n/g, '<br>');
                            }
                        }
                        break;
                    }
                    case 'download_progress': {
                        const logOutput2 = document.getElementById('logContent');
                        if (data.message) {
                            logOutput2.textContent += `${data.message}\n`;
                            logOutput2.scrollTop = logOutput2.scrollHeight;
                            const m = data.message.match(/下载进度: ([\d.]+)%/);
                            if (m) {
                                const progress = parseFloat(m[1]);
                                const progressBar = document.querySelector('.progress-bar');
                                if (progressBar) progressBar.style.width = `${progress}%`;
                                const progressText = document.getElementById('downloadProgressText');
                                if (progressText) progressText.textContent = `下载进度: ${progress.toFixed(1)}%`;
                            }
                        }
                        if (data.completed) {
                            if (data.error) {
                                showResultModal('下载失败', data.error_message || '下载失败');
                            } else {
                                showResultModal('下载完成', 'frpc 已成功下载并解压到根目录。');
                            }
                            resetDownloadUI();
                        }
                        break;
                    }
                    case 'service_status':
                        updateStatusIndicator(data.status);
                        break;
                }
            } catch (error) {
                console.error('处理 WebSocket 消息失败:', error, '原始消息:', event.data);
            }
        };
    });
}

// 检查并下载 frpc（新版：直接请求接口，等待返回结果）
async function checkAndDownloadFrpc() {
    try {
        // 检查文件是否存在
        const checkResponse = await fetch('/check-frpc');
        if (!checkResponse.ok) {
            throw new Error('检查文件失败');
        }
        let checkResult = await checkResponse.json();
        if (checkResult.exists) {
            showResultModal('下载取消', '目录中已存在 frpc 文件，请先删除后再下载。');
            return;
        }

        // 显示进度条 UI
        const progressContainer = document.getElementById('downloadProgressContainer');
        const progressBar = document.querySelector('.progress-bar');
        const progressText = document.getElementById('downloadProgressText');
        const startDownloadBtn = document.getElementById('startDownloadBtn');
        const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
        if (progressContainer) progressContainer.style.display = 'block';
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
        }
        if (progressText) progressText.textContent = '准备下载...';
        if (startDownloadBtn) startDownloadBtn.style.display = 'none';
        if (cancelDownloadBtn) cancelDownloadBtn.style.display = 'inline-block';

        // 通过 WebSocket 订阅下载进度
        await connectWebSocket();
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'start_download_progress' }));
        }

        // 日志窗口显示开始下载信息
        const logOutput = document.getElementById('logContent');
        logOutput.textContent = '开始下载 frpc...\n';

        // 请求后端下载接口（异步进行）
        const downloadResponse = await fetch('/download-frpc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        let downloadResult = await downloadResponse.json();
        if (downloadResult.status === 'success') {
            // 成功结果会由 WebSocket 消息处理弹框与重置UI
            console.log('下载完成: ', downloadResult.message);
        } else {
            // 失败结果也会在 WebSocket 中处理一次，这里兜底
            console.warn('下载失败: ', downloadResult.message);
            showResultModal('下载失败', downloadResult.message || '下载失败');
            resetDownloadUI();
        }
    } catch (error) {
        const logOutput = document.getElementById('logContent');
        if (logOutput) logOutput.textContent += `下载失败: ${error.message}\n`;
        showResultModal('下载失败', error.message);
        resetDownloadUI();
    }
}

// 取消下载
function cancelDownload() {
    console.log('发送取消下载请求');
    fetch('/cancel-download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('取消下载响应:', data);
        if (data.status === 'success') {
            // 立即更新UI状态
            const logOutput2 = document.getElementById('logContent');
            logOutput2.textContent += '下载已取消\n';
            showResultModal('下载已取消', '下载任务已被用户取消');
            resetDownloadUI();
        } else {
            console.error('取消下载失败:', data.message);
            showResultModal('错误', data.message);
        }
    })
    .catch(error => {
        console.error('取消下载请求失败:', error);
        showResultModal('错误', '取消下载请求失败');
    });
}

// 重置下载 UI
function resetDownloadUI() {
    console.log('重置下载 UI');
    
    // 重置按钮状态
    const startDownloadBtn = document.getElementById('startDownloadBtn');
    const cancelDownloadBtn = document.getElementById('cancelDownloadBtn');
    if (startDownloadBtn) startDownloadBtn.style.display = 'block';
    if (cancelDownloadBtn) cancelDownloadBtn.style.display = 'none';
    
    // 隐藏进度条
    const progressContainer = document.getElementById('downloadProgressContainer');
    if (progressContainer) progressContainer.style.display = 'none';
    
    // 重置进度条
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
    }
    const progressText = document.getElementById('downloadProgressText');
    if (progressText) progressText.textContent = '';
    
    // 关闭对话框
    const downloadModal = document.getElementById('downloadConfirmModal');
    if (downloadModal) {
        const modalInstance = bootstrap.Modal.getInstance(downloadModal);
        if (modalInstance) {
            console.log('关闭下载对话框');
            modalInstance.hide();
            // 确保对话框完全关闭
            downloadModal.addEventListener('hidden.bs.modal', function handler() {
                downloadModal.removeEventListener('hidden.bs.modal', handler);
                // 移除对话框的 backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                // 移除 body 的 modal-open 类
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, { once: true });
        }
    }
    
    // 清理可能存在的其他模态框
    const allModals = document.querySelectorAll('.modal');
    allModals.forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // 清理所有 backdrop
    const allBackdrops = document.querySelectorAll('.modal-backdrop');
    allBackdrops.forEach(backdrop => backdrop.remove());
    
    // 重置 body 样式
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    console.log('下载 UI 重置完成');
}

// 开始日志监听
async function startLogPolling() {
    stopLogPolling(); // 先清理旧定时器，防止多次叠加
    connectWebSocket().then(() => {
        // 立即请求一次日志
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'get_log' }));
        }
        // 定时请求
        wsLogTimer = setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_log' }));
            }
        }, 2000);
    }).catch(error => {
        console.warn('启动日志监听失败:', error);
        // 避免在切换标签或网络瞬断时打扰用户
    });
}

function stopLogPolling() {
    if (wsLogTimer) {
        clearInterval(wsLogTimer);
        wsLogTimer = null;
    }
    // 保持 WebSocket 连接，避免频繁断开导致报错
}

// 获取日志
function fetchLog() {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'get_log' }));
    }
}

// 清空日志
function clearLog() {
    document.getElementById('logContent').textContent = '';
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'clear_log' }));
    }
}

// 启动服务
async function startService() {
    try {
        const response = await fetch('/frpc/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        alert(data.message);
        updateServiceStatus();
    } catch (error) {
        console.error('启动服务失败:', error);
        alert('启动服务失败: ' + error.message);
    }
}

// 停止服务
async function stopService() {
    try {
        const response = await fetch('/frpc/stop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        alert(data.message);
        updateServiceStatus();
    } catch (error) {
        console.error('停止服务失败:', error);
        alert('停止服务失败: ' + error.message);
    }
}

// 重启服务
async function restartService() {
    try {
        const response = await fetch('/frpc/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        alert(data.message);
        updateServiceStatus();
    } catch (error) {
        console.error('重启服务失败:', error);
        alert('重启服务失败: ' + error.message);
    }
}

// 更新服务状态
async function updateServiceStatus() {
    try {
        const response = await fetch('/frpc/status');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const statusBadge = document.getElementById('statusBadge');
        var startBtn = document.getElementById('startBtn');
        var stopBtn = document.getElementById('stopBtn');
        var restartBtn = document.getElementById('restartBtn');
        if (statusBadge) {
            if (data.status === 'running') {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = `运行中 (PID: ${data.pid})`;
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = '已停止';
            }
        }
        if (startBtn) startBtn.disabled = (data.status === 'running');
        if (stopBtn) stopBtn.disabled = (data.status !== 'running');
        if (restartBtn) restartBtn.disabled = (data.status !== 'running');
    } catch (error) {
        console.error('获取服务状态失败:', error);
        const statusBadge = document.getElementById('statusBadge');
        if (statusBadge) {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = '状态获取失败';
        }
    }
}

// 更新日志
async function updateLogs() {
    try {
        const response = await fetch('/frpc/logs');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const logOutput = document.getElementById('logContent');
        if (logOutput) {
            logOutput.textContent = data.logs.join('');
            logOutput.scrollTop = logOutput.scrollHeight;
        }
    } catch (error) {
        console.error('获取日志失败:', error);
    }
}

// 更新状态指示器
function updateStatusIndicator(status) {
    const indicator = document.getElementById('statusIndicator');
    const dot = indicator.querySelector('.status-dot');
    const text = indicator.querySelector('.status-text');
    
    // 移除所有状态类
    dot.classList.remove('online', 'offline', 'error');
    
    switch(status) {
        case 'running':
            dot.classList.add('online');
            text.textContent = 'frpc 运行中';
            break;
        case 'stopped':
            dot.classList.add('offline');
            text.textContent = 'frpc 已停止';
            break;
        case 'error':
            dot.classList.add('error');
            text.textContent = 'frpc 错误';
            break;
        default:
            dot.classList.add('offline');
            text.textContent = 'frpc 状态';
    }
}

// 1. 新增WebSocket方式监听frpc状态
function startFrpcStatusWS() {
    connectWebSocket().then(_ws => {
        if (_ws && _ws.readyState === WebSocket.OPEN) {
            _ws.send(JSON.stringify({type: 'get_status'}));
        }
    });
}

// 启用表头拖拽滚动
function enableHeaderDragScroll(headerSelector, scrollContainerSelector) {
    const header = document.querySelector(headerSelector);
    const scroller = document.querySelector(scrollContainerSelector) || document.querySelector('#configTabsContent');
    if (!header || !scroller) return;

    let isDown = false;
    let startX = 0;
    let scrollLeft = 0;

    header.classList.add('drag-scroll');

    header.addEventListener('mousedown', (e) => {
        // 仅在桌面端鼠标左键
        if (e.button !== 0) return;
        isDown = true;
        header.classList.add('dragging');
        startX = e.pageX;
        scrollLeft = scroller.scrollLeft;
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        const walk = (e.pageX - startX);
        scroller.scrollLeft = scrollLeft - walk;
    });

    document.addEventListener('mouseup', () => {
        if (!isDown) return;
        isDown = false;
        header.classList.remove('dragging');
    });
}

// 页面加载时启动ws监听
document.addEventListener('DOMContentLoaded', function() {
    loadConfig();

    // 启用服务器配置、客户端配置的表头拖拽滚动（滚动容器为 #configTabsContent）
    enableHeaderDragScroll('#server .modern-table thead', '#configTabsContent');
    enableHeaderDragScroll('#client .modern-table thead', '#configTabsContent');

    document.getElementById('status-tab').addEventListener('shown.bs.tab', function() {
        stopLogPolling();
        startLogPolling();
    });
    document.getElementById('status-tab').addEventListener('hidden.bs.tab', function() {
        stopLogPolling();
    });
    startFrpcStatusWS();
    if (document.getElementById('status-tab').classList.contains('active')) {
        startLogPolling();
    }
});

function openConfigManager() {
    // 清空提示
    document.getElementById('configFormatTip').textContent = '';
    // 读取当前配置到编辑框
    readConfigFile();
    new bootstrap.Modal(document.getElementById('configManagerModal')).show();
}

function readConfigFile() {
    fetch('/config.json').then(r => r.json()).then(data => {
        // 创建新的配置对象，不包含 enabled 字段
        const displayConfig = {
            serverAddr: data.serverAddr,
            serverPort: data.serverPort,
            webServer: data.webServer,
            auth: data.auth,
            proxies: data.proxies.map(proxy => {
                const { enabled, ...rest } = proxy;
                return rest;
            })
        };
        document.getElementById('configTextarea').value = JSON.stringify(displayConfig, null, 2);
        document.getElementById('configFormatTip').textContent = '';
    }).catch(() => {
        document.getElementById('configTextarea').value = '';
        document.getElementById('configFormatTip').textContent = '未找到 config.json 文件';
    });
}

function exportConfigFile() {
    fetch('/config.json').then(r => r.json()).then(data => {
        // 创建新的配置对象，不包含 enabled 字段
        const exportConfig = {
            serverAddr: data.serverAddr,
            serverPort: data.serverPort,
            webServer: data.webServer,
            auth: data.auth,
            proxies: data.proxies.map(proxy => {
                const { enabled, ...rest } = proxy;
                return rest;
            })
        };
        
        const blob = new Blob([JSON.stringify(exportConfig, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
}

function saveConfigFile() {
    const text = document.getElementById('configTextarea').value;
    let json;
    try {
        json = JSON.parse(text);
        document.getElementById('configFormatTip').textContent = '';
    } catch (err) {
        document.getElementById('configFormatTip').textContent = '不是有效的 JSON 格式，无法保存！';
        return;
    }
    
    // 为每个客户端配置添加 enabled 字段
    if (json.proxies) {
        json.proxies = json.proxies.map(proxy => ({
            ...proxy,
            enabled: true  // 默认启用
        }));
    }
    
    // 检查是否已存在
    fetch('/config.json').then(r => {
        if (r.ok) {
            showConfirmModal('确认替换', 'config.json 已存在，是否替换？', () => {
                doSaveConfig(json);
            });
        } else {
            doSaveConfig(json);
        }
    }).catch(() => {
        doSaveConfig(json);
    });
}

function doSaveConfig(json) {
    fetch('/save-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') {
            // 如果有启用的配置，保存到 frpc.json
            const enabledProxies = json.proxies.filter(proxy => proxy.enabled !== false);
            if (enabledProxies.length > 0) {
                const frpcConfig = {
                    ...json,
                    proxies: enabledProxies.map(proxy => {
                        const { enabled, ...rest } = proxy;
                        return rest;
                    })
                };
                
                fetch('/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(frpcConfig)
                }).then(() => {
                    alert('保存成功！');
                    loadConfig();
                }).catch(() => {
                    alert('保存成功，但 frpc.json 保存失败！');
                    loadConfig();
                });
            } else {
                // 如果没有启用的配置，删除 frpc.json
                fetch('/delete-frpc-config', {
                    method: 'POST'
                }).then(() => {
                    alert('保存成功！');
                    loadConfig();
                }).catch(() => {
                    alert('保存成功，但删除 frpc.json 失败！');
                    loadConfig();
                });
            }
        } else {
            alert('保存失败：' + (data.message || '未知错误'));
        }
    }).catch(() => {
        alert('保存失败！');
    });
}

// 检查会话状态
async function checkSession() {
    try {
        // 使用已存在的接口，避免 404；该接口受 login_required 保护
        const response = await fetch('/frpc/status', { headers: { 'Accept': 'application/json' } });
        if (response.status === 401 || response.status === 403) {
            // 未登录或会话过期
            window.location.href = '/login';
            return false;
        }
        // 其它状态码（如 200）视为有效；404 不应出现
        return response.ok;
    } catch (error) {
        console.error('检查会话失败:', error);
        return false;
    }
}

// 定期检查会话状态（已取消按分钟轮询）
// setInterval(checkSession, 60000);

// 处理 API 响应
async function handleApiResponse(response) {
    if (response.status === 401) {
        // 未登录或会话过期
        window.location.href = '/login';
        throw new Error('会话已过期，请重新登录');
    }
    
    if (response.status === 404) {
        throw new Error('请求的接口不存在');
    }
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
        throw new Error('服务器返回了非 JSON 响应');
    }
    
    return await response.json();
}

// 更新状态显示
async function updateStatus() {
    try {
        if (!await checkSession()) return;
        
        const response = await fetch('/frpc/status');
        const data = await handleApiResponse(response);
        
        const statusBadge = document.getElementById('statusBadge');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const restartBtn = document.getElementById('restartBtn');
    } catch (error) {
        console.error('更新服务状态失败:', error);
        alert('更新服务状态失败: ' + error.message);
    }
}

// 添加切换客户端启用状态的函数
function toggleClientEnabled(idx, enabled) {
    clientConfigs[idx].enabled = enabled;
}

// 修改文件导入处理
document.getElementById('importConfigFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) {
        console.log('未选择文件');
        return;
    }
    
    console.log('选择的文件:', file.name, '大小:', file.size, '类型:', file.type);
    
    const reader = new FileReader();
    
    reader.onload = function(evt) {
        console.log('文件读取完成');
        try {
            // 获取文件内容并去除可能的 BOM 标记
            let content = evt.target.result;
            console.log('文件内容长度:', content.length);
            
            if (content.charCodeAt(0) === 0xFEFF) {
                content = content.slice(1);
                console.log('已移除 BOM 标记');
            }
            
            // 尝试解析 JSON
            const json = JSON.parse(content);
            console.log('JSON 解析成功');
            
            // 验证必要的字段
            if (!json.serverAddr || !json.serverPort) {
                throw new Error('配置文件缺少必要的服务器配置字段');
            }
            
            // 确保 proxies 是数组
            if (json.proxies && !Array.isArray(json.proxies)) {
                throw new Error('proxies 必须是数组');
            }
            
            // 确保导入的配置不包含 enabled 字段
            if (json.proxies) {
                json.proxies = json.proxies.map(proxy => {
                    const { enabled, ...rest } = proxy;
                    return rest;
                });
            }
            
            // 格式化 JSON 并显示
            const formattedJson = JSON.stringify(json, null, 2);
            console.log('格式化后的 JSON:', formattedJson);
            
            const textarea = document.getElementById('configTextarea');
            textarea.value = formattedJson;
            console.log('已更新文本框内容');
            
            document.getElementById('configFormatTip').textContent = '文件导入成功';
            document.getElementById('configFormatTip').className = 'form-text text-success';
        } catch (err) {
            console.error('解析配置文件失败:', err);
            document.getElementById('configFormatTip').textContent = `文件内容格式错误: ${err.message}`;
            document.getElementById('configFormatTip').className = 'form-text text-danger';
            document.getElementById('configTextarea').value = '';
        }
    };
    
    reader.onerror = function(error) {
        console.error('读取文件失败:', error);
        document.getElementById('configFormatTip').textContent = '读取文件失败，请重试';
        document.getElementById('configFormatTip').className = 'form-text text-danger';
    };
    
    // 读取文件内容
    console.log('开始读取文件...');
    reader.readAsText(file, 'UTF-8');
});

// 添加文本区域输入验证
document.getElementById('configTextarea').addEventListener('input', function() {
    try {
        const content = this.value.trim();
        if (!content) {
            document.getElementById('configFormatTip').textContent = '';
            document.getElementById('configFormatTip').className = 'form-text';
            return;
        }
        
        const json = JSON.parse(content);
        
        // 验证必要的字段
        if (!json.serverAddr || !json.serverPort) {
            throw new Error('配置文件缺少必要的服务器配置字段');
        }
        
        // 确保 proxies 是数组
        if (json.proxies && !Array.isArray(json.proxies)) {
            throw new Error('proxies 必须是数组');
        }
        
        document.getElementById('configFormatTip').textContent = 'JSON 格式正确';
        document.getElementById('configFormatTip').className = 'form-text text-success';
    } catch (err) {
        console.error('JSON 格式错误:', err);
        document.getElementById('configFormatTip').textContent = `JSON 格式错误: ${err.message}`;
        document.getElementById('configFormatTip').className = 'form-text text-danger';
    }
});
</script>
</body>
</html> 